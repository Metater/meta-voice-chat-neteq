name: Build NetEQ Wrapper
on: [push, workflow_dispatch]
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-15
            target: x86_64-apple-darwin
            name: macos-intel
          - os: macos-latest
            target: aarch64-apple-darwin
            name: macos-arm
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            name: linux-arm64
          - os: macos-latest
            target: aarch64-apple-ios
            name: ios-arm64
          - os: ubuntu-latest
            target: aarch64-linux-android
            name: android-arm64
          - os: windows-latest
            target: x86_64-pc-windows-gnu
            name: windows-x86_64
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install cmake
      
      - name: Install dependencies (Linux x86_64)
        if: runner.os == 'Linux' && matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libasound2-dev
      
      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install msys2
          $env:PATH = "C:\tools\msys64\mingw64\bin;$env:PATH"
          echo "C:\tools\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh
      
      - name: Install cross-compilation tools (Linux ARM)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          cargo install cross --git https://github.com/cross-rs/cross
          
          cat > Cross.toml << 'CROSSEOF'
          [target.aarch64-unknown-linux-gnu]
          pre-build = [
              "dpkg --add-architecture arm64",
              "apt-get update",
              "apt-get install -y libasound2-dev:arm64"
          ]
          CROSSEOF
      
      - name: Setup Android NDK
        if: matrix.target == 'aarch64-linux-android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
      
      - name: Configure Android environment
        if: matrix.target == 'aarch64-linux-android'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake
          
          mkdir -p .cargo
          cat > .cargo/config.toml << 'CARGOEOF'
          [target.aarch64-linux-android]
          ar = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          linker = "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          CARGOEOF
          
          sed -i "s|\$ANDROID_NDK_HOME|$ANDROID_NDK_HOME|g" .cargo/config.toml
          
          echo "CC=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" >> $GITHUB_ENV
          echo "CXX=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang++" >> $GITHUB_ENV
          echo "AR=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar" >> $GITHUB_ENV
      
      - name: Patch audiopus CMakeLists.txt (pre-build - Unix)
        if: matrix.target != 'aarch64-unknown-linux-gnu' && runner.os != 'Windows'
        run: |
          cargo fetch
          
          if [ -d "$HOME/.cargo/registry/src" ]; then
            find "$HOME/.cargo/registry/src" -name "audiopus_sys-*" -type d | while read dir; do
              cmakefile="$dir/opus/CMakeLists.txt"
              if [ -f "$cmakefile" ]; then
                echo "Patching $cmakefile"
                sed -i.bak 's/cmake_minimum_required(VERSION [0-9.]*)/cmake_minimum_required(VERSION 3.5)/' "$cmakefile"
              fi
            done
          fi
        shell: bash
      
      - name: Patch audiopus CMakeLists.txt (pre-build - Windows)
        if: runner.os == 'Windows'
        run: |
          cargo fetch
          
          $registryPath = "$env:USERPROFILE\.cargo\registry\src"
          if (Test-Path $registryPath) {
            Get-ChildItem -Path $registryPath -Directory -Filter "audiopus_sys-*" -Recurse | ForEach-Object {
              $cmakeFile = Join-Path $_.FullName "opus\CMakeLists.txt"
              if (Test-Path $cmakeFile) {
                Write-Host "Patching $cmakeFile"
                $content = Get-Content $cmakeFile -Raw
                $content = $content -replace 'cmake_minimum_required\(VERSION [0-9.]+\)', 'cmake_minimum_required(VERSION 3.5)'
                $content | Set-Content $cmakeFile -NoNewline
              }
            }
          }
        shell: pwsh
      
      - name: Build (standard targets)
        if: matrix.target != 'aarch64-unknown-linux-gnu'
        run: cargo build --release --target ${{ matrix.target }} --lib
        env:
          CMAKE_ARGS: "-DCMAKE_POLICY_VERSION_MINIMUM=3.5"
      
      - name: Build (Linux ARM64 using cross)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: cross build --release --target ${{ matrix.target }} --lib
        env:
          CROSS_CONTAINER_OPTS: "--env CMAKE_ARGS=-DCMAKE_POLICY_VERSION_MINIMUM=3.5"
      
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/${{ matrix.name }}
          find target/${{ matrix.target }}/release -maxdepth 1 -type f \( -name "*.so" -o -name "*.dylib" -o -name "*.a" -o -name "*.dll" -o -name "*.rlib" \) -exec cp {} artifacts/${{ matrix.name }}/ \; 2>/dev/null || true
        shell: bash
      
      - name: Upload build artifacts (temporary)
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.name }}
          path: artifacts/${{ matrix.name }}/*
          retention-days: 1

  combine-artifacts:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
      
      - name: Combine artifacts
        run: |
          mkdir -p combined
          for platform_dir in all-artifacts/build-*; do
            platform_name=$(basename "$platform_dir" | sed 's/build-//')
            mkdir -p "combined/$platform_name"
            cp -r "$platform_dir"/* "combined/$platform_name/" 2>/dev/null || true
          done
          
          cat > combined/README.md << 'EOF'
          # NetEQ Wrapper Builds
          
          This package contains compiled libraries for multiple platforms:
          
          - macos-intel/ - macOS Intel (x86_64)
          - macos-arm/ - macOS Apple Silicon (ARM64)
          - linux-x86_64/ - Linux x86_64
          - linux-arm64/ - Linux ARM64
          - ios-arm64/ - iOS ARM64
          - android-arm64/ - Android ARM64
          - windows-x86_64/ - Windows x86_64
          EOF
      
      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: all-platforms
          path: combined/
      
      - name: Delete temporary artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: build-*
